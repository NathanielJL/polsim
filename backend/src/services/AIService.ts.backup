/**
 * Claude AI Integration Service
 * Handles all AI-powered game features:
 * - Event generation & description
 * - News article writing
 * - Policy consequence analysis
 * - Population response simulation
 * - Political archetype evolution analysis
 */

import Anthropic from "@anthropic-ai/sdk";
import { Event, Policy, PopulationGroup, IdeologyPoint } from "../models/types";
import ZealandiaContext from "./ZealandiaContext";

const client = new Anthropic();

// Load Zealandia context on startup
ZealandiaContext.loadContext();

// ===== CONFIGURATION =====
const CONFIG = {
  MODEL: "claude-3-5-sonnet-20241022",
  MAX_TOKENS: 2048,
  CACHE_TTL: 86400000, // 24 hours (cache AI responses to save money)
};

// Simple in-memory cache (replace with Redis in production)
const cache = new Map<string, { value: any; expiresAt: number }>();

// ===== CACHE HELPERS =====
function cacheKey(...parts: string[]): string {
  return parts.join("|");
}

function getCached(key: string): any {
  const entry = cache.get(key);
  if (entry && entry.expiresAt > Date.now()) {
    return entry.value;
  }
  cache.delete(key);
  return null;
}

function setCached(key: string, value: any): void {
  cache.set(key, {
    value,
    expiresAt: Date.now() + CONFIG.CACHE_TTL,
  });
}

// ===== EVENT GENERATION =====
/**
 * Generate narrative descriptions for events based on context
 */
export async function generateEventDescription(
  event: Partial<Event>,
  context: {
    gdpTrend: string;
    unemployment: number;
    populationMood: number;
    recentPolicies: string[];
    recentEvents: string[];
  }
): Promise<string> {
  const cacheK = cacheKey("event-desc", event.type || "", JSON.stringify(context));
  const cached = getCached(cacheK);
  if (cached) return cached;

  const prompt = `You are generating an event description for a political economy simulation.

Event Type: ${event.type}
Severity: ${event.severity}/10

Current Context:
- GDP Trend: ${context.gdpTrend}
- Unemployment: ${context.unemployment}%
- Population Mood: ${context.populationMood > 0 ? "Optimistic" : "Pessimistic"}
- Recent Policies: ${context.recentPolicies.join(", ") || "None"}
- Recent Events: ${context.recentEvents.join(", ") || "None"}

Create a vivid, realistic narrative description (2-3 paragraphs) that:
1. Feels contextually appropriate
2. Has clear consequences
3. Creates multiple possible outcomes
4. Fits the current political climate

Description:`;

  const message = await client.messages.create({
    model: CONFIG.MODEL,
    max_tokens: 512,
    messages: [
      {
        role: "user",
        content: prompt,
      },
    ],
  });

  const description =
    message.content[0].type === "text" ? message.content[0].text : "";
  setCached(cacheK, description);
  return description;
}

// ===== NEWS ARTICLE GENERATION =====
/**
 * Generate news articles with outlet-specific bias
 */
export async function generateNewsArticle(
  eventTitle: string,
  eventDescription: string,
  outletName: string,
  outletIdeology: IdeologyPoint
): Promise<string> {
  const cacheK = cacheKey("article", outletName, eventTitle);
  const cached = getCached(cacheK);
  if (cached) return cached;

  const ideologyString =
    outletIdeology.economic > 0
      ? "right-wing"
      : outletIdeology.economic < 0
        ? "left-wing"
        : "centrist";

  const prompt = `You are a news writer for ${outletName}, a ${ideologyString} political outlet.

Write a 2-3 paragraph news article about the following event that reflects this outlet's typical coverage style and political perspective.

Event: ${eventTitle}
Description: ${eventDescription}

The article should:
1. Include a headline and body text
2. Reflect the outlet's ideological bias (subtly, not obviously propaganda)
3. Include plausible quotes (you may create realistic quotes)
4. Suggest causes/effects that align with the outlet's ideology
5. Be compelling enough readers would want to read it

Article:`;

  const message = await client.messages.create({
    model: CONFIG.MODEL,
    max_tokens: 512,
    messages: [
      {
        role: "user",
        content: prompt,
      },
    ],
  });

  const article =
    message.content[0].type === "text" ? message.content[0].text : "";
  setCached(cacheK, article);
  return article;
}

// ===== POLICY CONSEQUENCE ANALYSIS =====
/**
 * Analyze realistic effects of a proposed policy
 */
export async function analyzePolicyConsequences(
  policy: Policy
): Promise<{
  gdpEffect: number;
  unemploymentEffect: number;
  budgetEffect: number;
  approvalByGroup: Record<string, number>;
  eventTriggerRisk: number;
  unintendedConsequences: string[];
}> {
  const prompt = `Analyze the consequences of this proposed policy for a political economy simulation.

Policy: ${policy.title}
Description: ${policy.description}
Political Alignment: Economic ${policy.ideology.economic}, Social ${policy.ideology.social}, Personal ${policy.ideology.personal}

Provide analysis in JSON format:
{
  "gdpEffect": <-30 to +30, percentage point change>,
  "unemploymentEffect": <-5 to +5, percentage point change>,
  "budgetEffect": <-50 to +50, percentage>,
  "approvalByGroup": {
    "AuthRight": <-25 to +25>,
    "RightModerate": <-25 to +25>,
    "Centrist": <-25 to +25>,
    "LeftModerate": <-25 to +25>,
    "LibLeft": <-25 to +25>
  },
  "eventTriggerRisk": <0-100, probability>,
  "unintendedConsequences": [<list of 2-3 realistic unintended effects>]
}`;

  const message = await client.messages.create({
    model: CONFIG.MODEL,
    max_tokens: 800,
    messages: [
      {
        role: "user",
        content: prompt,
      },
    ],
  });

  const responseText =
    message.content[0].type === "text" ? message.content[0].text : "{}";

  // Extract JSON from response
  const jsonMatch = responseText.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error("Failed to parse policy analysis");
  }

  return JSON.parse(jsonMatch[0]);
}

// ===== POPULATION RESPONSE SIMULATION =====
/**
 * Determine how a specific group responds to an event
 */
export async function predictGroupResponse(
  group: PopulationGroup,
  eventDescription: string,
  eventType: string
): Promise<{
  approvalChange: number;
  willProtest: boolean;
  willCelebrate: boolean;
  willIgnore: boolean;
  likelyToBePersuaded: boolean;
  narrativeExplanation: string;
}> {
  const prompt = `You are predicting how a population group responds to an event.

Group: ${group.archetype} (Class ${group.classLevel})
Current Approval: ${group.approval}
Employment Rate: ${group.employed}%

Event Type: ${eventType}
Event: ${eventDescription}

Predict their response in JSON format:
{
  "approvalChange": <-25 to +25>,
  "willProtest": <boolean>,
  "willCelebrate": <boolean>,
  "willIgnore": <boolean>,
  "likelyToBePersuaded": <boolean>,
  "narrativeExplanation": "<short explanation of response>"
}`;

  const message = await client.messages.create({
    model: CONFIG.MODEL,
    max_tokens: 400,
    messages: [
      {
        role: "user",
        content: prompt,
      },
    ],
  });

  const responseText =
    message.content[0].type === "text" ? message.content[0].text : "{}";
  const jsonMatch = responseText.match(/\{[\s\S]*\}/);

  if (!jsonMatch) {
    throw new Error("Failed to parse group response");
  }

  return JSON.parse(jsonMatch[0]);
}

// ===== ARCHETYPE EVOLUTION ANALYSIS =====
/**
 * Analyze population for emerging ideological clusters
 */
export async function analyzeArchetypeEvolution(
  populationState: {
    groups: PopulationGroup[];
    recentEvents: string[];
    activePolicies: string[];
    gdp: number;
    unemployment: number;
  },
  currentTurn: number
): Promise<{
  emergingClusters: Array<{
    name: string;
    ideology: IdeologyPoint;
    predictedSize: number;
    growthReason: string;
    willReachOfficial: boolean;
    turnsUntilOfficial: number;
  }>;
  radicalizationRisks: Array<{
    archetype: string;
    risk: number;
    reason: string;
  }>;
  mergePredictions: Array<{
    source: string;
    target: string;
    probability: number;
  }>;
  summary: string;
}> {
  const groupsSummary = populationState.groups
    .map((g) => `${g.archetype}: ${g.size}% (approval: ${g.approval})`)
    .join("\n");

  const prompt = `Analyze the political evolution of a simulated population.

Current Population Distribution (Turn ${currentTurn}):
${groupsSummary}

Recent Events: ${populationState.recentEvents.join(", ")}
Active Policies: ${populationState.activePolicies.join(", ")}
GDP: ${populationState.gdp}
Unemployment: ${populationState.unemployment}%

Analyze in JSON format:
{
  "emergingClusters": [
    {
      "name": "<new archetype name>",
      "ideology": {"economic": <-100-100>, "social": <-100-100>, "personal": <-100-100>},
      "predictedSize": <0-100>,
      "growthReason": "<why this cluster is forming>",
      "willReachOfficial": <boolean>,
      "turnsUntilOfficial": <5-20>
    }
  ],
  "radicalizationRisks": [
    {
      "archetype": "<name>",
      "risk": <0-100>,
      "reason": "<why this group might radicalize>"
    }
  ],
  "mergePredictions": [
    {
      "source": "<archetype>",
      "target": "<archetype>",
      "probability": <0-1>
    }
  ],
  "summary": "<2-3 sentence summary of political trajectory>"
}`;

  const message = await client.messages.create({
    model: CONFIG.MODEL,
    max_tokens: 1200,
    messages: [
      {
        role: "user",
        content: prompt,
      },
    ],
  });

  const responseText =
    message.content[0].type === "text" ? message.content[0].text : "{}";
  const jsonMatch = responseText.match(/\{[\s\S]*\}/);

  if (!jsonMatch) {
    throw new Error("Failed to parse archetype evolution");
  }

  return JSON.parse(jsonMatch[0]);
}

// ===== GAME MASTER INSTRUCTION PROCESSING =====
/**
 * Process natural language instructions from GMs
 */
export async function processGMInstruction(
  instruction: string,
  context: string,
  currentGameState: any
): Promise<{
  understanding: string;
  suggestedActions: string[];
  estimatedImpact: string;
  requiresApproval: boolean;
}> {
  const prompt = `You are helping a Game Master manage a political economy simulation.

GM Instruction: "${instruction}"

Context: ${context}

Current Game State:
- Turn: ${currentGameState.currentTurn}
- GDP: ${currentGameState.gdp}
- Unemployment: ${currentGameState.unemployment}%
- Population Mood: ${currentGameState.populationMood}

Analyze in JSON format:
{
  "understanding": "<what the GM wants to achieve>",
  "suggestedActions": [<list of specific game actions to execute>],
  "estimatedImpact": "<predicted effect on game state>",
  "requiresApproval": <boolean, true if it's a major change>
}`;

  const message = await client.messages.create({
    model: CONFIG.MODEL,
    max_tokens: 800,
    messages: [
      {
        role: "user",
        content: prompt,
      },
    ],
  });

  const responseText =
    message.content[0].type === "text" ? message.content[0].text : "{}";
  const jsonMatch = responseText.match(/\{[\s\S]*\}/);

  if (!jsonMatch) {
    throw new Error("Failed to parse GM instruction");
  }

  return JSON.parse(jsonMatch[0]);
}

// ===== UTILITY: CLEAR CACHE =====
export function clearCache(): void {
  cache.clear();
}

// ===== UTILITY: GET CACHE STATS =====
export function getCacheStats() {
  return {
    cacheSize: cache.size,
    memorySafe: cache.size < 10000,
  };
}

// Export AIService class placeholder
export class AIService {
  // Placeholder for future methods
}

export { client as anthropicClient };
  
  // Analyze policy proposal in natural language
   // Extract structured data and calculate impacts
  async analyzePolicyProposal(title: string, description: string): Promise<any> {
    const cacheK = cacheKey("policy-analysis", title, description);
    const cached = getCached(cacheK);
    if (cached) return cached;

    try {
      const context = ZealandiaContext.getAIContext();
      
      const prompt = `You are analyzing a policy proposal for the Zealandia political simulation.

${context}

POLICY PROPOSAL:
Title: ${title}
Description: ${description}

Extract the following information and respond ONLY with valid JSON:

{
  "success": true,
  "policyType": "tax|tariff|land_reform|immigration|labor|resource_regulation|infrastructure|education|maori_rights|electoral_reform|other",
  "summary": "one sentence summary of the policy",
  "affectedResources": ["timber", "wool", etc],
  "affectedProvinces": ["province names if specific, empty if all"],
  "economicImpact": {
    "gdpChange": 0.05,
    "unemploymentChange": -0.02,
    "inflationChange": 0.01
  },
  "reputationImpact": {
    "upper_class": -10,
    "middle_class": 5,
    "working_class": 15,
    "lower_class": 10
  },
  "resourcePriceChanges": {
    "timber": 0.10
  },
  "estimatedRevenue": 12000,
  "estimatedCost": 5000
}

Analyze based on 1853 New Zealand context.`;

      const response = await client.messages.create({
        model: CONFIG.MODEL,
        max_tokens: CONFIG.MAX_TOKENS,
        messages: [
          {
            role: "user",
            content: prompt,
          },
        ],
      });

      const content = response.content[0];
      if (content.type !== "text") {
        throw new Error("Unexpected response type");
      }

      const result = JSON.parse(content.text);
      setCached(cacheK, result);
      return result;
    } catch (error: any) {
      console.error("AI policy analysis error:", error);
      return {
        success: false,
        error: error.message,
      };
    }
  }

  async analyzeGMEvent(title: string, description: string): Promise<any> {
    const cacheK = cacheKey("event-analysis", title, description);
    const cached = getCached(cacheK);
    if (cached) return cached;

    try {
      const context = ZealandiaContext.getAIContext();
      
      const prompt = `You are analyzing a Game Master event for the Zealandia political simulation.

${context}

EVENT:
Title: ${title}
Description: ${description}

Extract information and respond ONLY with valid JSON:
Title: ${title}
Description: ${description}

Extract information and respond ONLY with valid JSON:

{
  "success": true,
  "eventType": "natural_disaster|economic_crisis|resource_discovery|war|immigration_wave|epidemic|other",
  "severity": 5,
  "duration": 3,
  "summary": "one sentence",
  "affectedProvinces": [],
  "affectedResources": [],
  "effects": {
    "population": { "change": -500, "provinces": ["Southland"] },
    "gdp": { "changePercent": -0.15, "provinces": ["all"] },
    "resources": {
      "timber": { "supplyChange": -0.20, "priceChange": 0.30 }
    },
    "unemployment": { "changePercent": 0.05 },
    "reputation": { "government": -20 }
  }
}

Be realistic for 1853 New Zealand.`;

      const response = await client.messages.create({
        model: CONFIG.MODEL,
        max_tokens: CONFIG.MAX_TOKENS,
        messages: [
          {
            role: "user",
            content: prompt,
          },
        ],
      });

      const content = response.content[0];
      if (content.type !== "text") {
        throw new Error("Unexpected response type");
      }

      const result = JSON.parse(content.text);
      setCached(cacheK, result);
      return result;
    } catch (error: any) {
      console.error("AI event analysis error:", error);
      return {
        success: false,
        error: error.message,
      };
    }
  }

  /**
   * Generate news article from GM event
   * Creates neutral news coverage for 3 AI national newspapers
   */
  async generateNewsFromEvent(
    eventTitle: string, 
    eventDescription: string,
    eventType: string,
    affectedProvinces: string[]
  ): Promise<any> {
    const cacheK = cacheKey("news-gen", eventTitle, eventDescription);
    const cached = getCached(cacheK);
    if (cached) return cached;

    try {
      const context = ZealandiaContext.getAIContext();
      
      const prompt = `You are a news writer for Zealandia's national newspapers in 1854.

${context}

EVENT TO REPORT:
Title: ${eventTitle}
Description: ${eventDescription}
Type: ${eventType}
Affected Provinces: ${affectedProvinces.join(', ')}

Generate THREE news articles about this event, one for each newspaper with their editorial stance.
Respond ONLY with valid JSON:

{
  "success": true,
  "articles": [
    {
      "outlet": "The Zealandia Gazette",
      "stance": "Moderate/Government-Aligned/Populist",
      "headline": "concise headline (8-12 words)",
      "content": "full article text (300-400 words, 1854 newspaper style, formal tone)",
      "tone": "neutral/factual"
    },
    {
      "outlet": "The Progressive Herald",
      "stance": "Progressive/Reformist",
      "headline": "concise headline emphasizing reform angle",
      "content": "article with progressive spin (300-400 words)",
      "tone": "optimistic/reform-focused"
    },
    {
      "outlet": "The Frontier Economist",
      "stance": "Frontier/Economist",
      "headline": "concise headline emphasizing economic impact",
      "content": "article focusing on economic/frontier angle (300-400 words)",
      "tone": "practical/economic analysis"
    }
  ]
}

Write in authentic 1854 newspaper style: formal language, no contractions, proper Victorian prose.
Each article should present same facts but with different editorial emphasis based on newspaper stance.`;

      const response = await client.messages.create({
        model: CONFIG.MODEL,
        max_tokens: 3000, // More tokens for 3 articles
        messages: [
          {
            role: "user",
            content: prompt,
          },
        ],
      });

      const content = response.content[0];
      if (content.type !== "text") {
        throw new Error("Unexpected response type");
      }

      const result = JSON.parse(content.text);
      setCached(cacheK, result);
      return result;
    } catch (error: any) {
      console.error("AI news generation error:", error);
      return {
        success: false,
        error: error.message,
      };
    }
  }
  
  /**
   * Generate a court case for a lawyer
   * 1 case per lawyer per turn (civil or criminal)
   */
  async generateCourtCase(
    sessionId: string,
    lawyerId: string,
    province: string,
    currentTurn: number
  ): Promise<any> {
    try {
      // Get Zealandia context
      const constitution = ZealandiaContext.getConstitutionContext();
      const lore = ZealandiaContext.getLoreContext();
      
      const prompt = `You are generating a legal case for a lawyer in Zealandia, a fictional nation in the year 1854.

CONTEXT:
${constitution}

LEGAL SYSTEM:
${lore}

LOCATION: ${province} Province
TURN: ${currentTurn}

Generate a realistic legal case for this era. The case should reflect:
- 1850s legal issues (land disputes, treaty violations, property rights, contracts, theft, assault)
- Tension between British common law and Māori customary law
- Colonial economic issues (land sales, resource rights, trade disputes)
- Cultural conflicts (language barriers, different legal traditions)

Case types:
- CIVIL: Land disputes, contract violations, property claims, inheritance, debt collection
- CRIMINAL: Theft, assault, fraud, liquor law violations, illegal timber harvesting

Return JSON format:
{
  "success": true,
  "case": {
    "caseId": "case-${currentTurn}-${Date.now()}",
    "type": "civil" or "criminal",
    "title": "brief case name (e.g., 'MacDonald v. Te Arawa Land Trust')",
    "plaintiff": "plaintiff name and brief description",
    "defendant": "defendant name and brief description",
    "summary": "2-3 sentence case summary",
    "legalIssues": ["primary legal issue", "secondary legal issue"],
    "culturalContext": "Māori/British/Mixed - cultural dimension of case",
    "difficulty": 1-10 (1=simple, 10=complex constitutional issue),
    "potentialOutcomes": [
      {
        "outcome": "outcome description",
        "probability": 0.0-1.0,
        "reputationImpact": -10 to +10
      }
    ],
    "rewardRange": {
      "min": 20,
      "max": 120
    }
  }
}

Make the case feel authentic to 1854 colonial New Zealand. Include realistic names (British, Scottish, Māori). 
Focus on issues that would genuinely arise in this historical setting.`;

      const response = await client.messages.create({
        model: CONFIG.MODEL,
        max_tokens: 1500,
        messages: [
          {
            role: "user",
            content: prompt,
          },
        ],
      });

      const content = response.content[0];
      if (content.type !== "text") {
        throw new Error("Unexpected response type");
      }

      const result = JSON.parse(content.text);
      return result;
    } catch (error: any) {
      console.error("AI court case generation error:", error);
      return {
        success: false,
        error: error.message,
      };
    }
  }
  */
}

export { AIService };
